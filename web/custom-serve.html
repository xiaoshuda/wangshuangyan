<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>客户服务页面</title>
    <link rel="stylesheet" type="text/css" media="screen" href="css/jquery-ui-1.10.3.custom.min.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="css/ui.jqgrid.css" />
    <script type="text/javascript" language="javascript" src="js/jquery-1.8.2.js"></script>
    <script type="text/javascript" src="js/i18n/grid.locale-cn.js" ></script>
    <script type="text/javascript" src="js/jquery.jqGrid.min.js" ></script>
	<script type="text/javascript" src="js/color.js" ></script>
    <script type="text/javascript">
        jQuery.jgrid.no_legacy_api = true;
    </script>
  
    <style type="text/css">
        html, body {
            margin: 0;
            padding: 0;
            font-size: 75%;
        }
    </style>
    <script type="text/javascript">
        var mydata = [];
        $(function () {
            jQuery("#list2").jqGrid({
                data: mydata,
                datatype: "local",
                height: 200,
                rowNum: 10,
                rowList: [10,20,30],
                colNames:['用户', '内容'],
                colModel:[
                    
                    {name:'nick',index:'nick',width:50, sorttype:'text'},
                   
                    {name:'text',index:'text', width:350}
                ],
                pager: "#pager2",
                viewrecords: true,
                caption: "历史记录",
                //hiddengrid:true
            });
            $.ajax({
                type:'POST',
                url:'weibo.html',
                //url:'../Controller',
		data:{'flag':'service','nick':'empty'},
		dataType:'text',
                	success:function (data, textStatus, jqXHR){
                        eval('var weiboData = '+ data);
                        data = weiboData['items'];
                        frontData = [];
                        negativeData = [];
                        for(var i = 0;i < data.length;i++){
                            if(data[i]['sentiment'] == 1){//正面
                                frontData.push(data[i]);
                            }else if(data[i]['sentiment'] == -1){//负面
                                negativeData.push(data[i]);
                            }
                        }
                    //jQuery("#list").jqGrid('navGrid','#pager',{del:false,add:false,edit:false});
                jQuery("#list1").jqGrid({
                        data: data,
                        datatype: "local",
                         height: 200,
                rowNum: 10,
                rowList: [10,20,30],
                colNames:['用户', '内容'],
                colModel:[
                    
                    {name:'nick',index:'nick',width:50, sorttype:'text'},
                  
                    {name:'text',index:'text', width:350}
                ],
                        pager: "#pager1",
                        viewrecords: true,
                        caption: "留言列表",
                        onSelectRow:function (rowid,state,e){
                            var rowData = $("#list1").jqGrid("getRowData", rowid);
                            getListContent(rowData['nick']);
                        }
                        //loadonce:true
                    });
                    jQuery("#list1").jqGrid('navGrid','#pager1',{del:false,add:false,edit:false});

                },
                datatype:'json',
                error:function (XMLHttpRequest, textStatus, errorThrown){
                    console.log('error');
                }
            });

        });
        
        
        function getListContent(user){
            $.ajax({
                 url:'weibo.html',
                type:'POST',
               	data:{'flag':'service','nick':user},
               	dataType:'text',
                success:function (data, textStatus, jqXHR){
                    eval('var weiboData = '+ data);
					weiboData = color(weiboData);
                    data = weiboData['items'];
                    $('#list2').jqGrid('setGridState','visible');
                    jQuery('#list2').jqGrid('clearGridData');
                    jQuery("#list2").jqGrid('addRowData', 'idd', data);
                    //$('#list').jqGrid('trigger','reloadGrid');
                }
            });
        }
        function reply(){
            var content = $('#mytext').val();
            var rowid = $('#list1').jqGrid('getGridParam','selrow');
            if(!rowid){
                alert('please select data!');
                return;
            }
            if(content == ''){
                alert('please write content');
                return;
            }
            var rowData = $("#list1").jqGrid("getRowData", rowid);
            var replyData= [];
            var data2 = {};
            data2['nick'] = rowData['nick'];
            data2['text'] = rowData['text'];
            replyData.push(data2);
            var data = {};
                        data['nick'] = '客服';
            data['text'] = content;
            replyData.push(data);
                        jQuery("#list2").jqGrid('addRowData', 'idd', replyData);
            $.ajax({
                url:'weibo.html',
                type:'POST',
                data:{'flag':'service','content':content,'nick':rowData['nick']},
                 dataType:"text",
                
                success:function(data, textStatus, jqXHR){
                	
                     $('#list1').jqGrid('delRowData',rowid);
                    $('#mytext').val('');
                    //$('#list2').jqGrid('setGridState','hidden');
                    //jQuery('#list2').jqGrid('clearGridData');
                  
                }

            });
        }
        function showFrontData(){
            jQuery('#list1').jqGrid('clearGridData');
            jQuery("#list1").jqGrid('addRowData', 'idd', frontData);
        }
        function showNegativeData(){
            jQuery('#list1').jqGrid('clearGridData');
            jQuery("#list1").jqGrid('addRowData', 'idd', negativeData);
        }
    </script>


</head>
<body style="background-color: #fafafa;margin-top:-15px;padding:0;font: 80%/1.45em "Lucida Grande", Verdana, Arial, Helvetica, sans-serif;color: #333;">
	<div style="background-color: #499dc3;height:60px;">
	      <a href="./index.html"><img style="float:left;" src="css/img/home.png"/></a> 
              <h1 style="text-align:center;padding-top:12px;color:white;font-size:22px;">客户服务页面<span style="float:right;"><img src="css/img/ibm-logo-white.gif"/></span></h1>
	</div>
	 <div>
		<div style="float:left;margin-left:100px;margin-top:50px;font-size:10px;">
		  <input style="font-size:10px;" type="button" value="正面留言" onclick="showFrontData()"/>
          <input style="font-size:10px;" type="button" value="负面留言" onclick="showNegativeData()"/>
			<table id="list1"></table>
			<div id="pager1"></div>                        	
	        </div>
		<div style="float:left;margin-left:50px;margin-top:70px;">
			<table id="list2"></table>
			<div id="pager2"></div>
		</div>
        </div>
        <br>
		<div style="margin-top:400px;text-align:center;"> 
		<textarea cols="82" rows="12" name="mytext" id = 'mytext'></textarea>
		</div>
		<div style="text-align:center;">
		<input type="submit" value="回复" onclick="reply()"/></div>
	
</body>
</html>
